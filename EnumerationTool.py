import subprocess
import sys
import os
from colorama import init, Fore

# Initialize Colorama
init(autoreset=True)

def create_output_directory(directory):
    if not os.path.exists(directory):
        os.makedirs(directory)

def run_command(command, output_file):
    with open(output_file, 'w') as f:
        process = subprocess.Popen(command, stdout=subprocess.PIPE, stderr=subprocess.PIPE, text=True)
        for line in iter(process.stdout.readline, ''):
            print(Fore.GREEN + line, end='')  # Print colored output to terminal
            f.write(line)                    # Write output to file
        for line in iter(process.stderr.readline, ''):
            print(Fore.RED + line, end='', file=sys.stderr)  # Print colored error to terminal
            f.write(line)                             # Write error to file
        process.stdout.close()
        process.stderr.close()
        process.wait()

def enumerate_smb_shares(target_ip, output_dir):
    output_file = os.path.join(output_dir, f"smb_shares_{target_ip}.txt")
    print(f"Enumerating SMB shares on {target_ip}. Results will be saved to {output_file}...")
    command = ["smbclient", "-L", f"//{target_ip}", "-N"]
    run_command(command, output_file)

def enumerate_users(target_ip, output_dir):
    output_file = os.path.join(output_dir, f"users_{target_ip}.txt")
    print(f"Enumerating users on {target_ip}. Results will be saved to {output_file}...")
    command = ["rpcclient", "-U", "", "-N", target_ip, "-c", "enumdomusers"]
    run_command(command, output_file)

def run_gobuster_scan(target_url, output_dir):
    sanitized_url = target_url.replace('http://', '').replace('https://', '').replace('/', '_')
    output_file = os.path.join(output_dir, f"gobuster_{sanitized_url}.txt")
    print(f"Running Gobuster directory scan on {target_url}. Results will be saved to {output_file}...")
    command = ["gobuster", "dir", "-u", target_url, "-w", "/usr/share/wordlists/dirb/common.txt"]
    run_command(command, output_file)

def perform_enum4linux(target_ip, output_dir):
    output_file = os.path.join(output_dir, f"enum4linux_{target_ip}.txt")
    print(f"Running Enum4Linux on {target_ip}. Results will be saved to {output_file}...")
    command = ["enum4linux", "-a", target_ip]
    run_command(command, output_file)

def perform_nmap_smb_enum(target_ip, output_dir):
    output_file = os.path.join(output_dir, f"nmap_smb_enum_{target_ip}.txt")
    print(f"Running Nmap SMB enumeration scripts on {target_ip}. Results will be saved to {output_file}...")
    command = ["nmap", "-p 445", "--script", "smb-enum-shares,smb-enum-users", target_ip]
    run_command(command, output_file)

def perform_ldap_enum(target_ip, output_dir):
    output_file = os.path.join(output_dir, f"ldap_enum_{target_ip}.txt")
    print(f"Enumerating LDAP on {target_ip}. Results will be saved to {output_file}...")
    command = ["ldapsearch", "-x", "-H", f"ldap://{target_ip}", "-b", "dc=example,dc=com"]
    run_command(command, output_file)

def perform_nbtscan(target_ip, output_dir):
    output_file = os.path.join(output_dir, f"nbtscan_{target_ip}.txt")
    print(f"Running NetBIOS scan on {target_ip}. Results will be saved to {output_file}...")
    command = ["nbtscan", target_ip]
    run_command(command, output_file)

def main():
    if len(sys.argv) != 3:
        print("Usage: python EnumerationTool.py <target_ip_or_url> <enum_type>")
        print("Enumeration types:")
        print("1 = SMB Shares")
        print("2 = Users")
        print("3 = Web Directories")
        print("4 = Enum4Linux")
        print("5 = Nmap SMB Enumeration")
        print("6 = LDAP Enumeration")
        print("7 = NetBIOS Scan")
        sys.exit(1)

    target = sys.argv[1]
    enum_type = sys.argv[2]
    output_dir = "enumeration"
    create_output_directory(output_dir)
    if enum_type == "1":
        enumerate_smb_shares(target, output_dir)
    elif enum_type == "2":
        enumerate_users(target, output_dir)
    elif enum_type == "3":
        run_gobuster_scan(target, output_dir)
    elif enum_type == "4":
        perform_enum4linux(target, output_dir)
    elif enum_type == "5":
        perform_nmap_smb_enum(target, output_dir)
    elif enum_type == "6":
        perform_ldap_enum(target, output_dir)
    elif enum_type == "7":
        perform_nbtscan(target, output_dir)
    else:
        print("Invalid enumeration type. Choose from 1 to 7.")

if __name__ == "__main__":
    main()
